<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CBSP Workbench</title>
  <style>
    :root {
      --bg-a: #f4f8ff;
      --bg-b: #edf8f1;
      --text: #132238;
      --muted: #4f6280;
      --line: #d7e3ef;
      --card: #ffffff;
      --primary: #1d4ed8;
      --ok: #0f766e;
      --warn: #b45309;
      --danger: #b91c1c;
      --forbidden: #7c3aed;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 0% 0%, var(--bg-a), var(--bg-b));
    }
    .wrap {
      max-width: 1160px;
      margin: 0 auto;
      padding: 20px 16px 30px;
    }
    .hero {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
      background: linear-gradient(120deg, #ffffff, #eef5ff 45%, #eefbf5);
      box-shadow: 0 10px 22px rgba(20, 33, 56, 0.08);
    }
    .hero-top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .hero h1 {
      margin: 0;
      font-size: 26px;
    }
    .hero p {
      margin: 8px 0 0;
      color: var(--muted);
    }
    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      border: 1px solid #cfe0ff;
      background: #eef5ff;
      color: #1f4d99;
    }
    .chip.ok {
      border-color: #c7eee8;
      background: #ecfaf8;
      color: #0f766e;
    }
    .chip.warn {
      border-color: #f5dfc2;
      background: #fff7ea;
      color: #9a5408;
    }
    .auth {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      align-items: end;
    }
    .field label {
      display: block;
      margin-bottom: 4px;
      color: var(--muted);
      font-size: 13px;
    }
    .field input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
      font-size: 14px;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    button {
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(90deg, var(--primary), #2563eb);
    }
    button.secondary {
      color: #1f2a40;
      background: #fff;
      border-color: var(--line);
    }
    button.danger {
      background: linear-gradient(90deg, #b91c1c, #dc2626);
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .row {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 12px;
    }
    .nav {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      height: fit-content;
    }
    .nav h2 {
      margin: 2px 4px 8px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }
    .nav button {
      width: 100%;
      margin-bottom: 8px;
      text-align: left;
      background: #fff;
      color: #1f2a40;
      border: 1px solid var(--line);
    }
    .nav button.active {
      border-color: #bfd4ff;
      background: #edf4ff;
      color: #123b83;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
    }
    .state {
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #cde2ff;
      background: #eef6ff;
      color: #1f4a96;
      margin-bottom: 10px;
    }
    .state.loading {
      border-color: #cde2ff;
      background: #eef6ff;
      color: #1f4a96;
    }
    .state.empty {
      border-color: #cfe9e3;
      background: #edf9f6;
      color: #11695f;
    }
    .state.error {
      border-color: #f2cbcb;
      background: #fff3f3;
      color: #b91c1c;
    }
    .state.forbidden {
      border-color: #e2d6fb;
      background: #f6f1ff;
      color: var(--forbidden);
    }
    .state h3 {
      margin: 0 0 4px;
      font-size: 15px;
    }
    .state p {
      margin: 0;
      font-size: 13px;
      color: inherit;
      opacity: 0.95;
      white-space: pre-wrap;
    }
    .hidden {
      display: none;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .table th, .table td {
      text-align: left;
      border-bottom: 1px solid #e4ecf4;
      padding: 8px 4px;
      vertical-align: top;
    }
    .table th {
      color: var(--muted);
      font-weight: 600;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
    }
    .hint {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 920px) {
      .row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <div class="hero-top">
        <div>
          <h1>Workbench</h1>
          <p>Route guard + auth session + loading/empty/error/forbidden states.</p>
        </div>
        <div class="chips">
          <span id="chip-api" class="chip">API: checking...</span>
          <span id="chip-user" class="chip warn">Session: signed out</span>
          <span id="chip-role" class="chip">Role: guest</span>
        </div>
      </div>

      <form id="login-form" class="auth">
        <div class="field">
          <label for="username">Username</label>
          <input id="username" name="username" placeholder="admin.demo or agent.demo" />
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input id="password" name="password" type="password" placeholder="pass-1234" />
        </div>
        <div class="actions">
          <button id="btn-login" type="submit">Login</button>
          <button id="btn-admin" type="button" class="secondary" onclick="window.__cbspWorkbenchQuickLogin && window.__cbspWorkbenchQuickLogin('admin.demo','pass-1234','#/inbox');">Quick Admin</button>
          <button id="btn-agent" type="button" class="secondary" onclick="window.__cbspWorkbenchQuickLogin && window.__cbspWorkbenchQuickLogin('agent.demo','pass-1234','#/inbox');">Quick Agent</button>
          <button id="btn-logout" type="button" class="danger">Logout</button>
        </div>
      </form>
    </section>

    <section class="row">
      <aside class="nav">
        <h2>Routes</h2>
        <button data-route="/inbox">/inbox</button>
        <button data-route="/customers">/customers</button>
        <button data-route="/automations">/automations</button>
        <button data-route="/admin/integrations">/admin/integrations (forbidden demo)</button>
        <button data-route="/analytics">/analytics</button>
        <button id="goto-admin" class="secondary" type="button">Open Admin Dashboard</button>
      </aside>

      <main class="panel">
        <div id="view-state" class="state loading">
          <h3>loading</h3>
          <p>Waiting for route data...</p>
        </div>
        <div id="view-content" class="hidden"></div>
      </main>
    </section>
  </div>

  <script src="/apps/shared/auth-client.js"></script>
  <script>
    window.__CBSPWorkbenchBooted = false;
    window.__cbspWorkbenchQuickLogin = async function fallbackWorkbenchQuickLogin(username, password, targetHash) {
      if (window.__CBSPWorkbenchBooted) return;
      try {
        if (!window.CBSPAuth || typeof window.CBSPAuth.login !== "function") {
          alert("Auth client not loaded yet. Refresh this page once.");
          return;
        }
        await window.CBSPAuth.login(username, password);
        if (targetHash) location.hash = targetHash;
        location.reload();
      } catch (error) {
        alert("Quick login failed: " + ((error && error.message) || String(error)));
      }
    };

    function runWorkbench(auth) {
      window.__CBSPWorkbenchBooted = true;
      var stateEl = document.getElementById("view-state");
      var contentEl = document.getElementById("view-content");
      var chipApi = document.getElementById("chip-api");
      var chipUser = document.getElementById("chip-user");
      var chipRole = document.getElementById("chip-role");
      var form = document.getElementById("login-form");
      var usernameInput = document.getElementById("username");
      var passwordInput = document.getElementById("password");
      var loginBtn = document.getElementById("btn-login");
      var logoutBtn = document.getElementById("btn-logout");
      var quickAdminBtn = document.getElementById("btn-admin");
      var quickAgentBtn = document.getElementById("btn-agent");
      var gotoAdminBtn = document.getElementById("goto-admin");
      var navButtons = Array.from(document.querySelectorAll("[data-route]"));

      var routes = {
        "/inbox": { roles: ["admin", "manager", "agent"], loader: loadInbox },
        "/customers": { roles: ["admin", "manager", "agent"], loader: loadCustomers },
        "/automations": { roles: ["admin", "manager"], loader: loadAutomations },
        "/admin/integrations": { roles: ["admin"], loader: loadIntegrationDemo },
        "/analytics": { roles: ["admin", "manager", "agent"], loader: loadAnalytics },
      };

      function htmlEscape(input) {
        return String(input)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function setState(type, title, detail) {
        stateEl.className = "state " + type;
        stateEl.innerHTML =
          "<h3>" + htmlEscape(type) + "</h3>" +
          "<p><strong>" + htmlEscape(title) + "</strong>\n" + htmlEscape(detail || "") + "</p>";
        contentEl.classList.add("hidden");
        contentEl.innerHTML = "";
      }

      function setContent(html) {
        contentEl.innerHTML = html;
        contentEl.classList.remove("hidden");
      }

      function getCurrentRoute() {
        var hash = location.hash || "#/inbox";
        var route = hash.replace(/^#/, "");
        if (!routes[route]) return "/inbox";
        return route;
      }

      function setRoute(route) {
        location.hash = route;
      }

      function updateActiveNav(route) {
        navButtons.forEach(function (btn) {
          btn.classList.toggle("active", btn.getAttribute("data-route") === route);
        });
      }

      function updateSessionChips() {
        var session = auth.getSession();
        var role = auth.getRole() || "guest";
        chipRole.textContent = "Role: " + role;

        if (session && session.user && session.user.username) {
          chipUser.textContent = "Session: " + session.user.username;
          chipUser.className = "chip ok";
        } else if (session) {
          chipUser.textContent = "Session: active";
          chipUser.className = "chip ok";
        } else {
          chipUser.textContent = "Session: signed out";
          chipUser.className = "chip warn";
        }
      }

      async function checkHealth() {
        try {
          var response = await fetch(auth.apiBase + "/health");
          if (!response.ok) throw new Error("HTTP " + response.status);
          var payload = await response.json();
          chipApi.textContent = "API: " + payload.data.status + " (" + payload.data.dataDriver + ")";
          chipApi.className = "chip ok";
        } catch (_err) {
          chipApi.textContent = "API: offline";
          chipApi.className = "chip warn";
        }
      }

      function checkRoleAccess(route) {
        var def = routes[route];
        var role = auth.getRole();
        return Boolean(def && role && def.roles.indexOf(role) >= 0);
      }

      function parseApiError(error) {
        if (!error) return "Unknown error";
        if (error.traceId) return (error.message || "Request failed") + " (traceId=" + error.traceId + ")";
        return error.message || "Request failed";
      }

      async function loadInbox() {
        var payload = await auth.fetchJson("/api/messages?page=1&pageSize=10");
        var items = payload && payload.data && payload.data.items ? payload.data.items : [];
        if (!items.length) {
          setState("empty", "No inbox messages", "Try reconnecting channels or waiting for inbound events.");
          return;
        }
        setState("loading", "Route ready", "/inbox loaded.");
        setContent(
          "<h3>Inbox messages</h3>" +
          "<table class='table'><thead><tr><th>ID</th><th>Channel</th><th>Status</th><th>Content</th></tr></thead>" +
          "<tbody>" +
          items.map(function (item) {
            return "<tr><td class='mono'>" + htmlEscape(item.id) + "</td>" +
              "<td>" + htmlEscape(item.channel || "-") + "</td>" +
              "<td>" + htmlEscape(item.status || "-") + "</td>" +
              "<td>" + htmlEscape(item.content || "") + "</td></tr>";
          }).join("") +
          "</tbody></table>"
        );
      }

      async function loadCustomers() {
        var payload = await auth.fetchJson("/api/customers?page=1&pageSize=10");
        var items = payload && payload.data && payload.data.items ? payload.data.items : [];
        if (!items.length) {
          setState("empty", "No customers found", "Create customer records from inbound messages.");
          return;
        }
        setState("loading", "Route ready", "/customers loaded.");
        setContent(
          "<h3>Customers</h3>" +
          "<table class='table'><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Tags</th></tr></thead>" +
          "<tbody>" +
          items.map(function (item) {
            return "<tr><td class='mono'>" + htmlEscape(item.id) + "</td>" +
              "<td>" + htmlEscape(item.name || "-") + "</td>" +
              "<td>" + htmlEscape(item.email || "-") + "</td>" +
              "<td>" + htmlEscape((item.tags || []).join(", ") || "-") + "</td></tr>";
          }).join("") +
          "</tbody></table>"
        );
      }

      async function loadAutomations() {
        var payload = await auth.fetchJson("/api/automations?page=1&pageSize=10");
        var items = payload && payload.data && payload.data.items ? payload.data.items : [];
        if (!items.length) {
          setState("empty", "No automation rules", "Create a workflow trigger in admin dashboard.");
          return;
        }
        setState("loading", "Route ready", "/automations loaded.");
        setContent(
          "<h3>Automation rules</h3>" +
          "<table class='table'><thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Enabled</th></tr></thead>" +
          "<tbody>" +
          items.map(function (item) {
            return "<tr><td class='mono'>" + htmlEscape(item.id) + "</td>" +
              "<td>" + htmlEscape(item.name || "-") + "</td>" +
              "<td>" + htmlEscape(item.type || "-") + "</td>" +
              "<td>" + htmlEscape(String(Boolean(item.enabled))) + "</td></tr>";
          }).join("") +
          "</tbody></table>"
        );
      }

      async function loadIntegrationDemo() {
        var payload = await auth.fetchJson("/api/integrations");
        var items = payload && payload.data ? payload.data : [];
        if (!items.length) {
          setState("empty", "No integration records", "Connect at least one e-commerce platform.");
          return;
        }
        setState("loading", "Route ready", "/admin/integrations loaded.");
        setContent(
          "<h3>Admin-only integration view</h3>" +
          "<p class='hint'>This route is intentionally restricted to admin for forbidden-state demo.</p>" +
          "<table class='table'><thead><tr><th>ID</th><th>Platform</th><th>Status</th></tr></thead><tbody>" +
          items.map(function (item) {
            return "<tr><td class='mono'>" + htmlEscape(item.id) + "</td>" +
              "<td>" + htmlEscape(item.platform || "-") + "</td>" +
              "<td>" + htmlEscape(item.status || "-") + "</td></tr>";
          }).join("") +
          "</tbody></table>"
        );
      }

      async function loadAnalytics() {
        var payload = await auth.fetchJson("/api/analytics/summary");
        var data = payload && payload.data ? payload.data : null;
        if (!data) {
          setState("empty", "No analytics summary", "Send message traffic to populate metrics.");
          return;
        }
        setState("loading", "Route ready", "/analytics loaded.");
        setContent(
          "<h3>Analytics summary</h3>" +
          "<table class='table'><tbody>" +
          "<tr><th>Total messages</th><td>" + htmlEscape(data.totalMessages) + "</td></tr>" +
          "<tr><th>Total customers</th><td>" + htmlEscape(data.totalCustomers) + "</td></tr>" +
          "<tr><th>Average response (ms)</th><td>" + htmlEscape(data.avgResponseMs) + "</td></tr>" +
          "<tr><th>Translation p95 (ms)</th><td>" + htmlEscape(data.translationP95Ms) + "</td></tr>" +
          "</tbody></table>"
        );
      }

      async function renderRoute() {
        updateSessionChips();
        var route = getCurrentRoute();
        updateActiveNav(route);
        var routeDef = routes[route];

        if (!auth.isLoggedIn()) {
          setState("error", "Unauthorized", "Login is required before accessing " + route);
          return;
        }

        if (!checkRoleAccess(route)) {
          setState(
            "forbidden",
            "Forbidden",
            "Your role '" + (auth.getRole() || "unknown") + "' cannot access " + route + "."
          );
          return;
        }

        setState("loading", "Loading", "Fetching data for " + route + " ...");
        try {
          await routeDef.loader();
        } catch (error) {
          if (error && error.status === 401) {
            setState("error", "Unauthorized", "Session is invalid. Login again.\n" + parseApiError(error));
            return;
          }
          if (error && error.status === 403) {
            setState("forbidden", "Forbidden", parseApiError(error));
            return;
          }
          setState("error", "Error", parseApiError(error));
        }
      }

      async function doLogin(username, password) {
        loginBtn.disabled = true;
        setState("loading", "Signing in", "Authenticating " + (username || "<empty>") + " ...");
        try {
          await auth.login(username, password);
          updateSessionChips();
          await renderRoute();
        } catch (error) {
          setState("error", "Login failed", parseApiError(error));
        } finally {
          loginBtn.disabled = false;
        }
      }

      form.addEventListener("submit", function (event) {
        event.preventDefault();
        doLogin(usernameInput.value.trim(), passwordInput.value);
      });

      quickAdminBtn.addEventListener("click", function () {
        usernameInput.value = "admin.demo";
        passwordInput.value = "pass-1234";
        doLogin(usernameInput.value, passwordInput.value);
      });

      quickAgentBtn.addEventListener("click", function () {
        usernameInput.value = "agent.demo";
        passwordInput.value = "pass-1234";
        doLogin(usernameInput.value, passwordInput.value);
      });

      logoutBtn.addEventListener("click", function () {
        auth.logout();
        updateSessionChips();
        renderRoute();
      });

      navButtons.forEach(function (button) {
        button.addEventListener("click", function () {
          setRoute(button.getAttribute("data-route"));
        });
      });

      gotoAdminBtn.addEventListener("click", function () {
        window.location.href = "/apps/admin/";
      });

      window.addEventListener("hashchange", function () {
        renderRoute();
      });

      if (!location.hash) {
        setRoute("/inbox");
      } else {
        renderRoute();
      }
      checkHealth();
      updateSessionChips();
    }

    (function bootstrapWorkbench() {
      function startWorkbench() {
        if (!window.CBSPAuth) {
          var stateEl = document.getElementById("view-state");
          if (stateEl) {
            stateEl.className = "state error";
            stateEl.innerHTML =
              "<h3>error</h3><p><strong>Auth client not loaded</strong>\nRefresh this page or restart preview server.</p>";
          }
          return;
        }
        runWorkbench(window.CBSPAuth);
      }

      if (window.CBSPAuth) {
        startWorkbench();
        return;
      }

      var fallback = document.createElement("script");
      fallback.src = "/apps/shared/auth-client.js?v=20260224";
      fallback.onload = startWorkbench;
      fallback.onerror = startWorkbench;
      document.head.appendChild(fallback);
    })();
  </script>
</body>
</html>
